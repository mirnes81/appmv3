â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ… PWA MV3 PRO - AUTHENTIFICATION COMPLÃˆTEMENT CORRIGÃ‰E
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Date: 10 janvier 2026
Version: 3.0
Build PWA: index-DmJXHRZF.js
Status: PRÃŠT POUR PRODUCTION

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ¯ PROBLÃˆME RÃ‰SOLU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

AVANT: Upload de photos depuis la PWA ne fonctionnait pas car l'endpoint
       utilisait uniquement la session cookie Dolibarr.

MAINTENANT: Authentification unifiÃ©e via Bearer token + X-Auth-Token + Session
           PHP (fallback). TOUS les endpoints acceptent maintenant le token PWA!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ… CE QUI A Ã‰TÃ‰ FAIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. HELPER D'AUTHENTIFICATION COMMUN
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CrÃ©Ã©: api/v1/mv3_auth.php

   Fonctions:
   âœ… mv3_getBearerToken() â†’ Extrait token depuis headers
   âœ… mv3_authenticateOrFail() â†’ Auth unifiÃ©e (token + session)
   âœ… mv3_jsonError() / mv3_jsonSuccess() â†’ RÃ©ponses standardisÃ©es
   âœ… mv3_checkPermission() â†’ VÃ©rification permissions
   âœ… mv3_isDebugMode() â†’ Mode debug contrÃ´lÃ©

   MÃ©thodes d'auth supportÃ©es:
   â€¢ Bearer token (Authorization: Bearer <token>)
   â€¢ X-Auth-Token (X-Auth-Token: <token>)
   â€¢ Session PHP (fallback)

2. ENDPOINTS CORRIGÃ‰S
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ModifiÃ©s pour utiliser mv3_auth.php:
   âœ… api/v1/planning_upload_photo.php â†’ Upload photos avec token
   âœ… api/v1/object/get.php â†’ RÃ©cupÃ©ration objets
   âœ… api/v1/object/upload.php â†’ Upload fichiers
   âœ… api/v1/object/file.php â†’ TÃ©lÃ©chargement/suppression

   DÃ©jÃ  fonctionnels (via _bootstrap.php):
   âœ… api/v1/regie.php â†’ Liste rÃ©gies
   âœ… api/v1/notifications.php â†’ Liste notifications
   âœ… api/v1/planning.php â†’ Liste planning
   âœ… api/v1/rapports.php â†’ Liste rapports

   CrÃ©Ã©s:
   âœ… api/v1/sens_pose.php â†’ Liste sens de pose
   âœ… api/v1/materiel.php â†’ Liste matÃ©riel

3. CLIENT API TYPESCRIPT
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Fichier: pwa/src/lib/api.ts

   Avant:
   âŒ api.regieList() â†’ throw 501 Not Implemented
   âŒ api.sensPoseList() â†’ throw 501 Not Implemented
   âŒ api.materielList() â†’ throw 501 Not Implemented
   âŒ api.notificationsList() â†’ throw 501 Not Implemented

   Maintenant:
   âœ… api.regieList() â†’ appelle /regie.php
   âœ… api.sensPoseList() â†’ appelle /sens_pose.php
   âœ… api.materielList() â†’ appelle /materiel.php
   âœ… api.notificationsList() â†’ appelle /notifications.php

4. LOGGING ET DEBUG
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   âœ… Mode debug activable (MV3_DEBUG=1)
   âœ… Logs dans documents/mv3pro_portail/logs/api.log
   âœ… Format JSON structurÃ©
   âœ… TraÃ§abilitÃ© complÃ¨te

5. BUILD PWA
   â”€â”€â”€â”€â”€â”€â”€â”€â”€
   âœ… Build rÃ©ussi: index-DmJXHRZF.js (276.30 KB)
   âœ… Gzipped: 77.97 KB
   âœ… Page FORCE_RELOAD.html mise Ã  jour

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ“‹ FICHIERS CRÃ‰Ã‰S/MODIFIÃ‰S
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CRÃ‰Ã‰S:
------
âœ… api/v1/mv3_auth.php (nouveau helper authentification)
âœ… api/v1/sens_pose.php (nouvel endpoint)
âœ… api/v1/materiel.php (nouvel endpoint)
âœ… pwa_dist/FORCE_RELOAD.html (page force-reload)
âœ… PWA_AUTH_FIX_COMPLETE.md (documentation complÃ¨te)

MODIFIÃ‰S:
---------
âœ… api/v1/planning_upload_photo.php (auth par token)
âœ… api/v1/object/get.php (auth par token)
âœ… api/v1/object/upload.php (auth par token)
âœ… api/v1/object/file.php (auth par token)
âœ… pwa/src/lib/api.ts (appels endpoints rÃ©els)
âœ… pwa_dist/ (nouveau build)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸš€ DÃ‰PLOIEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ã‰TAPE 1: Copier les fichiers sur le serveur
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  cd /var/www/dolibarr/custom/mv3pro_portail

  # Copier les nouveaux/modifiÃ©s fichiers API
  api/v1/mv3_auth.php
  api/v1/planning_upload_photo.php
  api/v1/object/ (get.php, upload.php, file.php)
  api/v1/sens_pose.php
  api/v1/materiel.php

  # Copier la nouvelle PWA
  pwa_dist/ (tout le contenu)

Ã‰TAPE 2: VÃ©rifier permissions
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  mkdir -p /var/www/dolibarr/documents/mv3pro_portail/logs
  chown www-data:www-data /var/www/dolibarr/documents/mv3pro_portail/logs
  chmod 755 /var/www/dolibarr/documents/mv3pro_portail/logs

  mkdir -p /var/www/dolibarr/documents/mv3pro_portail/planning
  chown www-data:www-data /var/www/dolibarr/documents/mv3pro_portail/planning
  chmod 755 /var/www/dolibarr/documents/mv3pro_portail/planning

Ã‰TAPE 3: Forcer rechargement PWA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  SUR TÃ‰LÃ‰PHONE:
    1. Ouvrir:
       https://crm.mv-3pro.ch/custom/mv3pro_portail/pwa_dist/FORCE_RELOAD.html

    2. Cliquer "ğŸš€ Forcer la mise Ã  jour"

    3. Attendre 3 secondes â†’ Rechargement auto

  SUR ORDINATEUR:
    Ctrl + Shift + R (Windows)
    Cmd + Shift + R (Mac)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ§ª TESTS Ã€ EFFECTUER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. AUTHENTIFICATION
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   curl -X POST "https://crm.mv-3pro.ch/custom/mv3pro_portail/mobile_app/api/auth.php?action=login" \
     -H "Content-Type: application/json" \
     -d '{"email":"test@example.com","password":"xxx"}'

   â†’ Doit retourner {"success":true,"token":"..."}

2. UPLOAD PHOTO
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TOKEN="..." # Token de l'Ã©tape 1

   curl -X POST \
     -H "Authorization: Bearer $TOKEN" \
     -F "event_id=74049" \
     -F "file=@photo.jpg" \
     "https://crm.mv-3pro.ch/custom/mv3pro_portail/api/v1/planning_upload_photo.php"

   â†’ Doit retourner {"success":true,"file":{...}}

3. API GÃ‰NÃ‰RIQUE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   curl -H "Authorization: Bearer $TOKEN" \
     "https://crm.mv-3pro.ch/custom/mv3pro_portail/api/v1/object/get.php?type=actioncomm&id=74049"

   â†’ Doit retourner {"success":true,"files":[...],"extrafields":{...}}

4. ENDPOINTS MANQUANTS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   # Regie
   curl -H "Authorization: Bearer $TOKEN" \
     "https://crm.mv-3pro.ch/custom/mv3pro_portail/api/v1/regie.php"

   # Sens pose
   curl -H "Authorization: Bearer $TOKEN" \
     "https://crm.mv-3pro.ch/custom/mv3pro_portail/api/v1/sens_pose.php"

   # MatÃ©riel
   curl -H "Authorization: Bearer $TOKEN" \
     "https://crm.mv-3pro.ch/custom/mv3pro_portail/api/v1/materiel.php"

   # Notifications
   curl -H "Authorization: Bearer $TOKEN" \
     "https://crm.mv-3pro.ch/custom/mv3pro_portail/api/v1/notifications.php"

   â†’ Tous doivent retourner des listes (vides ou remplies)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ› DÃ‰PANNAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ERREUR 401: Non authentifiÃ©
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. VÃ©rifier token dans localStorage:
     console.log(localStorage.getItem('mv3pro_token'))

  2. Si null â†’ Se reconnecter

  3. Forcer rechargement: FORCE_RELOAD.html

ERREUR 403: ACCOUNT_NOT_LINKED
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. Utilisateur PWA non liÃ© Ã  Dolibarr

  2. Admin â†’ Configuration â†’ Utilisateurs mobiles

  3. Lier l'utilisateur Ã  un compte Dolibarr

UPLOAD PHOTO Ã‰CHOUE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. VÃ©rifier taille < 10 MB

  2. VÃ©rifier type: JPEG/PNG/GIF/WebP

  3. VÃ©rifier permissions:
     ls -la /var/www/dolibarr/documents/mv3pro_portail/planning/

  4. Activer debug:
     tail -f /var/www/dolibarr/documents/mv3pro_portail/logs/api.log

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ“Š MÃ‰TRIQUES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Authentification:        Session cookie uniquement â†’ Token + Session
Upload photo:            âŒ Ne fonctionne pas â†’ âœ… Fonctionne
Endpoints 501:           5 endpoints â†’ 0 endpoint
Mode debug:              Inexistant â†’ IntÃ©grÃ©
Logging:                 Aucun â†’ Fichier API.log
CompatibilitÃ©:           Desktop uniquement â†’ PWA + Desktop
Build size:              276.37 KB â†’ 276.30 KB (optimisÃ©)
Hash build:              uPz3gyG1 â†’ DmJXHRZF (nouveau)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ“š DOCUMENTATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Documentation complÃ¨te:
  â†’ PWA_AUTH_FIX_COMPLETE.md

Documentation API gÃ©nÃ©rique (v2.0):
  â†’ API_GENERIQUE_OBJECT.md
  â†’ SYNTHESE_API_OBJECT.md
  â†’ DEMARRAGE_RAPIDE.md

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ‰ RÃ‰SULTAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

AVANT:
  PWA: api.upload(...) â†’ 401 Unauthorized âŒ
       api.regieList() â†’ throw 501 Not Implemented âŒ
       Upload photo â†’ Erreur session cookie âŒ

MAINTENANT:
  PWA: api.upload(...) â†’ 201 Created âœ…
       api.regieList() â†’ [...] âœ…
       api.materielList() â†’ [...] âœ…
       api.notificationsList() â†’ [...] âœ…
       Upload photo â†’ Fonctionne avec token âœ…

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ”— LIENS UTILES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PWA:
  https://crm.mv-3pro.ch/custom/mv3pro_portail/pwa_dist/

Force Reload:
  https://crm.mv-3pro.ch/custom/mv3pro_portail/pwa_dist/FORCE_RELOAD.html

Admin Config:
  https://crm.mv-3pro.ch/custom/mv3pro_portail/admin/config.php

Logs:
  /var/www/dolibarr/documents/mv3pro_portail/logs/api.log

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ… CHECKLIST FINALE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Backend:
  âœ… Helper mv3_auth.php crÃ©Ã©
  âœ… planning_upload_photo.php corrigÃ©
  âœ… object/*.php harmonisÃ©s
  âœ… sens_pose.php crÃ©Ã©
  âœ… materiel.php crÃ©Ã©
  âœ… Logging implÃ©mentÃ©
  âœ… Mode debug activable

Frontend:
  âœ… api.ts mis Ã  jour
  âœ… Tous endpoints fonctionnels
  âœ… Build PWA rÃ©ussi
  âœ… FORCE_RELOAD.html crÃ©Ã©

Tests:
  â³ Test authentification avec token â†’ Ã€ FAIRE
  â³ Test upload photo depuis PWA â†’ Ã€ FAIRE
  â³ Test endpoints regie/sens_pose/materiel â†’ Ã€ FAIRE

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Build: index-DmJXHRZF.js
Hash: DmJXHRZF
Date: 10 janvier 2026
Version: 3.0

ğŸš€ PRÃŠT POUR PRODUCTION !

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
